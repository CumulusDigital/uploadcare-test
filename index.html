<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Multi Ad Upload with Preview + Validation</title>

  <script>
    UPLOADCARE_PUBLIC_KEY = 'a51c89007d0bce21876e';
  </script>
  <script src="https://ucarecdn.com/libs/widget/3.x/uploadcare.full.min.js"></script>

  <style>
    body {
      font-family: sans-serif;
      padding: 2rem;
      background: #f5f5f5;
    }

    #upload-btn {
      padding: 10px 20px;
      background: #0073e6;
      color: white;
      border: none;
      border-radius: 5px;
      cursor: pointer;
    }

    .file-result {
      background: white;
      padding: 1rem;
      margin-top: 1rem;
      border-radius: 8px;
      box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
      display: flex;
      align-items: center;
      gap: 1rem;
    }

    .file-result.success {
      border-left: 4px solid green;
    }

    .file-result.error {
      border-left: 4px solid red;
      color: red;
    }

    .file-preview img {
      max-width: 100px;
      max-height: 100px;
      object-fit: contain;
      border: 1px solid #ccc;
      border-radius: 4px;
    }

    .file-details {
      flex: 1;
    }

    .file-list {
      margin-top: 1rem;
    }
  </style>
</head>
<body>

  <button id="upload-btn">Upload Ads</button>

  <div id="file-results" class="file-list"></div>

  <script>
    const requiredDimensions = [
      [300, 250], [728, 90], [300, 600], [160, 600], [320, 50], [320, 480]
    ];
    const allowedAdditionalDimensions = [
      [336, 280], [768, 1024], [848, 480], [1200, 1200], [900, 1600]
    ];
    const allAllowedDimensions = [...requiredDimensions, ...allowedAdditionalDimensions];

    const imageMimeTypes = ['image/png', 'image/jpeg', 'image/gif'];
    const zipMimeType = 'application/zip';

    const maxSizeImage = 500 * 1024; // 500 KB
    const maxSizeZip = 1024 * 1024;  // 1 MB

    const uploadBtn = document.getElementById('upload-btn');
    const resultsContainer = document.getElementById('file-results');

    uploadBtn.addEventListener('click', () => {
      const dialog = uploadcare.openDialog(null, {
        multiple: true,
        multipleMax: 10,
        tabs: 'file' // restrict to local files only
      });

      dialog.done(async (filesPromise) => {
        const files = await filesPromise.files();
        resultsContainer.innerHTML = ''; // Clear previous results

        for (const filePromise of files) {
          const fileInfo = await filePromise;
          const fileName = fileInfo.name;
          const mimeType = fileInfo.mimeType;
          const sizeKB = Math.round(fileInfo.size / 1024);

          const resultEl = document.createElement('div');
          resultEl.classList.add('file-result');

          const previewEl = document.createElement('div');
          previewEl.className = 'file-preview';

          const detailsEl = document.createElement('div');
          detailsEl.className = 'file-details';

          try {
            if (imageMimeTypes.includes(mimeType)) {
              if (fileInfo.size > maxSizeImage) {
                throw new Error(`Too large (${sizeKB} KB). Max: 500 KB.`);
              }

              const img = new Image();
              img.crossOrigin = 'anonymous';
              img.src = fileInfo.cdnUrl;

              await new Promise((resolve, reject) => {
                img.onload = () => {
                  const matches = allAllowedDimensions.some(
                    ([w, h]) => img.width === w && img.height === h
                  );
                  if (!matches) {
                    reject(new Error(`Wrong dimensions: ${img.width}x${img.height}. Allowed: ${allAllowedDimensions.map(([w, h]) => `${w}x${h}`).join(', ')}`));
                  } else {
                    previewEl.appendChild(img);
                    resolve();
                  }
                };
                img.onerror = () => reject(new Error(`Could not check dimensions.`));
              });

              resultEl.classList.add('success');
              detailsEl.innerHTML = `<strong>${fileName}</strong> (${sizeKB} KB)<br>✅ Valid image.`;

            } else if (mimeType === zipMimeType) {
              if (fileInfo.size > maxSizeZip) {
                throw new Error(`Too large (${sizeKB} KB). Max ZIP: 1 MB.`);
              }

              resultEl.classList.add('success');
              detailsEl.innerHTML = `<strong>${fileName}</strong> (${sizeKB} KB)<br>✅ Valid HTML5 ZIP.`;

            } else {
              throw new Error(`Unsupported file type.`);
            }
          } catch (err) {
            resultEl.classList.add('error');
            detailsEl.innerHTML = `<strong>${fileName}</strong> (${sizeKB} KB)<br>❌ ${err.message}`;
          }

          resultEl.appendChild(previewEl);
          resultEl.appendChild(detailsEl);
          resultsContainer.appendChild(resultEl);
        }
      });
    });
  </script>
</body>
</html>
