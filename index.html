<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Ad Upload with Persistent Preview + Remove</title>

  <script>
    UPLOADCARE_PUBLIC_KEY = 'a51c89007d0bce21876e';
  </script>
  <script src="https://ucarecdn.com/libs/widget/3.x/uploadcare.full.min.js"></script>

  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600&display=swap" rel="stylesheet" />

  <style>
    body {
      font-family: 'Inter', sans-serif;
      padding: 2rem;
      background: #ffffff;
    }
    #upload-btn {
      padding: 10px 20px;
      background: #0073e6;
      color: white;
      border: none;
      border-radius: 6px;
      cursor: pointer;
      font-size: 16px;
    }
    .file-result {
      background: white;
      padding: 1rem;
      margin-top: 1rem;
      border-radius: 8px;
      box-shadow: 0 1px 4px rgba(0, 0, 0, 0.08);
      display: flex;
      align-items: center;
      gap: 1rem;
      border-left: 4px solid transparent;
      position: relative;
    }
    .file-result.success {
      border-left-color: green;
    }
    .file-result.error {
      border-left-color: red;
      color: #d32f2f;
    }
    .file-preview img {
      max-width: 100px;
      max-height: 100px;
      object-fit: contain;
      border: 1px solid #ccc;
      border-radius: 4px;
    }
    .file-details {
      flex: 1;
    }
    .remove-btn {
      position: absolute;
      top: 6px;
      right: 6px;
      background: #ff4c4c;
      border: none;
      color: white;
      width: 24px;
      height: 24px;
      border-radius: 50%;
      font-weight: bold;
      cursor: pointer;
      line-height: 20px;
      font-size: 16px;
    }
    .allowed-sizes {
      color: green;
      font-weight: 600;
      margin-top: 0.5rem;
    }
    .file-list {
      margin-top: 1.5rem;
      max-height: 400px;
      overflow-y: auto;
    }
  </style>
</head>
<body>

  <button id="upload-btn">Upload Ads</button>

  <div id="file-results" class="file-list"></div>

  <div class="allowed-sizes">
    Allowed sizes: 300x250, 728x90, 300x600, 160x600, 320x50, 320x480, 336x280, 768x1024, 848x480, 1200x1200, 900x1600
  </div>

  <script>
    const requiredDimensions = [
      [300, 250], [728, 90], [300, 600], [160, 600], [320, 50], [320, 480]
    ];
    const allowedAdditionalDimensions = [
      [336, 280], [768, 1024], [848, 480], [1200, 1200], [900, 1600]
    ];
    const allAllowedDimensions = [...requiredDimensions, ...allowedAdditionalDimensions];

    const imageMimeTypes = ['image/png', 'image/jpeg', 'image/gif'];
    const zipMimeType = 'application/zip';

    const maxSizeImage = 500 * 1024; // 500 KB
    const maxSizeZip = 1024 * 1024;  // 1 MB

    const uploadBtn = document.getElementById('upload-btn');
    const resultsContainer = document.getElementById('file-results');

    // Helper to create remove button
    function createRemoveBtn() {
      const btn = document.createElement('button');
      btn.textContent = '×';
      btn.className = 'remove-btn';
      btn.title = 'Remove this file';
      return btn;
    }

    uploadBtn.addEventListener('click', () => {
      const dialog = uploadcare.openDialog(null, {
        multiple: true,
        multipleMax: 20,
        tabs: 'file',
        // Restrict to local files only:
        inputAcceptTypes: 'image/gif,image/jpeg,image/png,application/zip'
      });

      dialog.done(async (filesPromise) => {
        const files = await filesPromise.files();

        for (const filePromise of files) {
          const fileInfo = await filePromise;
          const fileName = fileInfo.name;
          const mimeType = fileInfo.mimeType;
          const sizeKB = Math.round(fileInfo.size / 1024);

          const resultEl = document.createElement('div');
          resultEl.classList.add('file-result');

          const previewEl = document.createElement('div');
          previewEl.className = 'file-preview';

          const detailsEl = document.createElement('div');
          detailsEl.className = 'file-details';

          // Add remove button and hook event
          const removeBtn = createRemoveBtn();
          removeBtn.onclick = () => {
            resultsContainer.removeChild(resultEl);
          };
          resultEl.appendChild(removeBtn);

          try {
            if (imageMimeTypes.includes(mimeType)) {
              if (fileInfo.size > maxSizeImage) {
                throw new Error(`Too large (${sizeKB} KB). Max: 500 KB.`);
              }

              const img = new Image();
              img.crossOrigin = 'anonymous';
              img.src = fileInfo.cdnUrl;

              await new Promise((resolve, reject) => {
                img.onload = () => {
                  const matches = allAllowedDimensions.some(
                    ([w, h]) => img.width === w && img.height === h
                  );
                  if (!matches) {
                    reject(new Error(`Wrong dimensions: ${img.width}x${img.height}.`));
                  } else {
                    previewEl.appendChild(img);
                    resolve();
                  }
                };
                img.onerror = () => reject(new Error(`Could not check dimensions.`));
              });

              resultEl.classList.add('success');
              detailsEl.innerHTML = `<strong>${fileName}</strong> (${sizeKB} KB)<br>✅ Valid image.`;

            } else if (mimeType === zipMimeType) {
              if (fileInfo.size > maxSizeZip) {
                throw new Error(`Too large (${sizeKB} KB). Max ZIP: 1 MB.`);
              }

              resultEl.classList.add('success');
              detailsEl.innerHTML = `<strong>${fileName}</strong> (${sizeKB} KB)<br>✅ Valid HTML5 ZIP.`;

            } else {
              throw new Error(`Unsupported file type.`);
            }
          } catch (err) {
            resultEl.classList.add('error');
            detailsEl.innerHTML = `<strong>${fileName}</strong> (${sizeKB} KB)<br>❌ ${err.message}`;
          }

          resultEl.appendChild(previewEl);
          resultEl.appendChild(detailsEl);
          resultsContainer.appendChild(resultEl);
        }
      });
    });
  </script>
</body>
</html>
